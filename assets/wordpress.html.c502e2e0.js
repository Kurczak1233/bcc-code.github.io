import{_ as s,r as l,o,c as r,a as e,b as i,d as t,f as a}from"./app.1ded8a6d.js";const d={},c=a('<h2 id="page-content" tabindex="-1"><a class="header-anchor" href="#page-content" aria-hidden="true">#</a> Page Content</h2><hr><ul><li><a href="#getting-started">Getting started</a><ul><li><a href="#prerequisites">Prerequisites</a></li><li><a href="#quickstart-guide">Quickstart guide</a></li></ul></li><li><a href="#installing-bcc-signon-on-wordpress">Installing BCC Signon on Wordpress</a><ul><li><a href="#system-requirements">System Requirements</a></li><li><a href="#prerequisite">Prerequisite</a></li><li><a href="#installation">Installation</a></li><li><a href="#create-a-new-admin-user">Create a new admin user</a></li></ul></li><li><a href="#plugin-configuration">Plugin configuration</a><ul><li><a href="#openid-connect-client-settings">OpenId Connect Client Settings</a><ul><li><a href="#login-type">Login Type</a></li><li><a href="#client-id--client-secret-key">Client ID &amp; Client Secret Key</a></li><li><a href="#openid-scope">OpenID Scope</a></li><li><a href="#enforce-privacy">Enforce Privacy</a></li><li><a href="#protected-urls--unprotected-urls">Protected URLs / Unprotected URLs</a></li><li><a href="#enable-logging">Enable Logging</a></li></ul></li><li><a href="#bcc-signon-settings">BCC Signon Settings</a><ul><li><a href="#bcc-signon-url">BCC Signon URL</a></li><li><a href="#enable-private-newsfeed">Enable private newsfeed</a></li><li><a href="#private-newsfeed-link">Private newsfeed link</a></li><li><a href="#enable-topbar">Enable TopBar</a></li><li><a href="#local-church">Local church</a></li></ul></li></ul></li><li><a href="#plugin-customization">Plugin customization</a><ul><li><a href="#hooks">Hooks</a></li><li><a href="#actions">Actions</a></li><li><a href="#user-meta-data">User Meta Data</a></li></ul></li><li><a href="#get-information-about-the-user">Get information about the user</a></li><li><a href="#how-sso-data-is-handled">How SSO data is handled</a></li><li><a href="#protect-uploads-files">Protect Uploads files</a></li><li><a href="#troubleshooting">Troubleshooting</a></li></ul><h1 id="getting-started" tabindex="-1"><a class="header-anchor" href="#getting-started" aria-hidden="true">#</a> Getting started</h1><p>This tutorial will explain you how to implement BCC Signon on a WordPress website.</p><h2 id="prerequisites" tabindex="-1"><a class="header-anchor" href="#prerequisites" aria-hidden="true">#</a> Prerequisites</h2><ul><li>You have received your Client ID and Client Secret. (If you haven’t, contact <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a>.)</li><li>Your admin user in WordPress does NOT have the same email address as your BCC user. (If it does, then change it and confirm the new email address for your WordPress admin user.)</li></ul><h2 id="quickstart-guide" tabindex="-1"><a class="header-anchor" href="#quickstart-guide" aria-hidden="true">#</a> Quickstart guide</h2><p>This a shortened version of the detailed documentation. If you encounter problems, check out the detailed documentation and <a href="#troubleshooting">the troubleshooting page</a></p>',9),u={href:"/_plugins/bcc-signon.zip",target:"_blank",rel:"noopener noreferrer"},h=a("<li>Log in to the admin panel of WordPress.</li><li>Navigate to <strong>Plugins</strong> → <strong>Add New</strong> → <strong>Upload Plugin</strong>, and find the downloaded file <strong>bcc-signon.zip</strong>. Install the plugin.</li><li>Once installed, click on <strong>Activate</strong>.</li>",3),p=e("strong",null,"Settings",-1),g=e("strong",null,"OpenID Connect Client",-1),m=e("li",null,[e("strong",null,"Login type"),i(": OpenID Connect button on login form")],-1),b=e("li",null,[e("strong",null,"Client ID"),i(": Your client ID")],-1),f=e("li",null,[e("strong",null,"Client Secret Key"),i(": Your client Secret")],-1),v=e("strong",null,"OpenID Scope",-1),w={href:"/_docs/bcc-signon/openid-connect#available-claims",target:"_blank",rel:"noopener noreferrer"},_=e("li",null,[e("strong",null,"Enable logging"),i(": Uncheck this unless you need logging.")],-1),y=a('<li>Save Changes</li><li>In the WordPress admin panel, go to <strong>Settings</strong> → <strong>BCC Signon</strong>. Here you may enable the TopBar and a private news feed. If you enable Private Newsfeeds, please send the Private newsfeed link to <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a>.</li><li>Save Changes</li><li>Test that it works: Open an incognito tab and visit your website. Login with OpenID Connect. If you experience any errors when testing, please see <a href="#troubleshooting">the troubleshooting page</a>.</li><li>After having tested the login with your BCC user, go the the WordPress admin panel. Then go to Users. You should see a user with your BCC email there. Promote that user to Administrator. You will now be able to access the admin panel with your BCC user.</li><li>Go to the incognito tab where you’re logged in with your BCC user and verify that you have admin rights with that user.</li><li>In the WordPress admin panel, go to <strong>Settings</strong> → <strong>OpenID Connect Client</strong> and change the <strong>Login type</strong> to Auto Login – SSO</li><li>Save Changes</li><li>If you followed all the steps above, login should now be set up correctly for your WordPress website. The following pages contain a more detailed version of the above steps, so you don’t need to read them if everything is working for you already.</li>',9),C=a('<p><strong>NOTE</strong>: If you experience that users have access to a limited dashboard and toolbar, please see <a href="#disable-dashboard-and-toolbar">this page</a>.</p><h1 id="installing-bcc-signon-on-wordpress" tabindex="-1"><a class="header-anchor" href="#installing-bcc-signon-on-wordpress" aria-hidden="true">#</a> Installing BCC Signon on Wordpress</h1><h2 id="system-requirements" tabindex="-1"><a class="header-anchor" href="#system-requirements" aria-hidden="true">#</a> System Requirements</h2><p>To get the best experience of our Auth0 Login, we suggest the following:</p><ol><li>WordPress 4.9 or greater</li><li>PHP 7.0 or greater</li><li>MySQL 5.6 or greater OR MariaDB 10 or greater</li></ol>',5),k={href:"https://wordpress.org/support/article/how-to-install-wordpress/",target:"_blank",rel:"noopener noreferrer"},S=e("h2",{id:"prerequisite",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#prerequisite","aria-hidden":"true"},"#"),i(" Prerequisite")],-1),P=e("p",null,[i("Before installing the plugin, make sure your admin user in WordPress does "),e("strong",null,"NOT"),i(" have the same email address as the one you use to log in to Brunstad Portal. If it does, then change it and confirm the new email address for your WordPress user.")],-1),I=e("h2",{id:"installation",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#installation","aria-hidden":"true"},"#"),i(" Installation")],-1),B={href:"/_plugins/bcc-signon.zip",target:"_blank",rel:"noopener noreferrer"},T=e("li",null,"Login to the admin panel of WordPress",-1),x=e("li",null,[i("Navigate to "),e("strong",null,"Plugins"),i(" → "),e("strong",null,"Add New"),i(" → "),e("strong",null,"Upload Plugin"),i(", and find the downloaded file bcc-signon.zip. Install the plugin.")],-1),$=e("li",null,[i("Once installed, click on "),e("strong",null,"Activate")],-1),W=a('<h2 id="create-a-new-admin-user" tabindex="-1"><a class="header-anchor" href="#create-a-new-admin-user" aria-hidden="true">#</a> Create a new admin user</h2><p>Open an incognito window or another browser and go to the administration panel on your WordPress website and log in with your Brunstad Portal account. This will create a new user in WordPress.</p><p>Now use the browser window you used to install the plugin (where you are logged in with Administrator access), go to the Users tab in the left panel of the WordPress dashboard, find your newly created user and make him an Administrator.</p><p>That’s it! Now you can use this user to access the administration dashboard, without any need to fill in credentials.</p><h1 id="plugin-configuration" tabindex="-1"><a class="header-anchor" href="#plugin-configuration" aria-hidden="true">#</a> Plugin configuration</h1><p>The settings of <strong>BCC Signon</strong> are grouped into two panels:</p><ul><li>OpenId Connect Client (OIDC Settings) contains all the settings related to the login of users.</li><li>BCC Signon (BCC Settings) contains all the setttings related to BCC’s widgets: newsfeeds, topbar</li></ul><h2 id="openid-connect-client-settings" tabindex="-1"><a class="header-anchor" href="#openid-connect-client-settings" aria-hidden="true">#</a> OpenId Connect Client Settings</h2><p>Most of the fields are pre-filled according to BCC’s configuration.</p><p>However, there are some settings you’ll have to configure:</p><h3 id="login-type" tabindex="-1"><a class="header-anchor" href="#login-type" aria-hidden="true">#</a> Login Type</h3><p>OpenID Connect button on login form – is set by default. Keep it this way while setting up/testing the plugin.</p><p>Auto Login – SSO will redirect automatically the users to Auth0 login page.<br><strong>Note:</strong> Activate this only when the plugin is ready to be launched on production.</p><h3 id="client-id-client-secret-key" tabindex="-1"><a class="header-anchor" href="#client-id-client-secret-key" aria-hidden="true">#</a> Client ID &amp; Client Secret Key</h3><p>Fill in your Client ID and Client Secret Key. If you have not received these, please contact <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a>.</p><h3 id="openid-scope" tabindex="-1"><a class="header-anchor" href="#openid-scope" aria-hidden="true">#</a> OpenID Scope</h3>',16),E={href:"/_docs/bcc-signon/openid-connect#available-claims",target:"_blank",rel:"noopener noreferrer"},L=a('<h3 id="enforce-privacy" tabindex="-1"><a class="header-anchor" href="#enforce-privacy" aria-hidden="true">#</a> Enforce Privacy</h3><p>With this setting you can decide whether the website will request authentication or not. In most of the cases this should be set to on and the <strong>Unprotected URLs</strong> field can be used to skip the privacy for one or more URLs.</p><h3 id="protected-urls-unprotected-urls" tabindex="-1"><a class="header-anchor" href="#protected-urls-unprotected-urls" aria-hidden="true">#</a> Protected URLs / Unprotected URLs</h3><p>This text field allows you to add / skip privacy for defined URLs. Regular expressions can very well be used as well. Example: if you want to add / skip privacy for all the articles which are under the category ‘local’, you would use “/local/”.</p><h3 id="enable-logging" tabindex="-1"><a class="header-anchor" href="#enable-logging" aria-hidden="true">#</a> Enable Logging</h3><p>A logger is available; it’s recommended to only use this for testing purposes since it uses the <code>wp_options</code> table to store the logs.</p><h2 id="bcc-signon-settings" tabindex="-1"><a class="header-anchor" href="#bcc-signon-settings" aria-hidden="true">#</a> BCC Signon Settings</h2><h3 id="bcc-signon-url" tabindex="-1"><a class="header-anchor" href="#bcc-signon-url" aria-hidden="true">#</a> BCC Signon URL</h3><p>This is BCC’s base URL for the authentication domain; this setting is pre-filled, you don’t need to change it.</p><h3 id="enable-private-newsfeed" tabindex="-1"><a class="header-anchor" href="#enable-private-newsfeed" aria-hidden="true">#</a> Enable private newsfeed</h3><p>If you want to integrate your website to BCC’s news feed widget, please enable this setting.</p><p>Otherwise, you can turn it off.</p><h3 id="private-newsfeed-link" tabindex="-1"><a class="header-anchor" href="#private-newsfeed-link" aria-hidden="true">#</a> Private newsfeed link</h3><p>If you have enabled the private newsfeed, the RSS feed will be available at this URL. Please share this URL with BCC IT by contacting <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a>.</p><h3 id="enable-topbar" tabindex="-1"><a class="header-anchor" href="#enable-topbar" aria-hidden="true">#</a> Enable TopBar</h3><p>This enables BCC’s new top bar widget, that you already see on this website.</p>',16),A={href:"/_docs/widgets/legacy-discontinued#old-topbar",target:"_blank",rel:"noopener noreferrer"},R=a(`<h3 id="local-church" tabindex="-1"><a class="header-anchor" href="#local-church" aria-hidden="true">#</a> Local church</h3><p>If you want to identify the users which log in to your website by church, e.g. for displaying specific content or give access to some pages just to members from your local church, find the church name in the list below and type it in in the text field on the BCC Login Settings page. If the church you’re coming from is not in the list you can contact <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a>.</p><ul><li><strong>Argentina</strong><ul><li>Paso Flores</li><li>Villa Regina</li></ul></li><li><strong>Australia</strong><ul><li>Melbourne</li><li>Sydney</li></ul></li><li><strong>Austria</strong><ul><li>Graz</li><li>Mittewald</li><li>Raumberg</li><li>Wien</li></ul></li><li><strong>Brasil</strong><ul><li>Novo Sarandi</li><li>Para</li></ul></li><li><strong>Cameroon</strong><ul><li>Bafoussam</li><li>Douala</li><li>Yaoundé</li></ul></li><li><strong>Canada</strong><ul><li>Ottawa</li><li>Toronto</li><li>Vancouver</li><li>Winnipeg</li></ul></li><li><strong>Chile</strong><ul><li>Curico</li><li>Valdivia</li></ul></li><li><strong>China</strong><ul><li>Shanghai</li><li>Shenzhen</li><li>Singapore</li></ul></li><li><strong>Congo</strong><ul><li>Congo</li></ul></li><li><strong>Denmark</strong><ul><li>Holstebro</li><li>København</li></ul></li><li><strong>England</strong><ul><li>Didcot</li><li>Huntworth</li></ul></li><li><strong>Finland</strong><ul><li>Kyrkslätt</li><li>Lahti</li></ul></li><li><strong>France</strong><ul><li>Nancy</li><li>Paris</li><li>Steinseltz</li></ul></li><li><strong>Germany</strong><ul><li>Dürrmenz</li><li>Exter</li><li>Fulda</li><li>Hamburg</li><li>Hessenhöfe</li><li>Lilienhof</li><li>Linnenbach</li><li>Maubach</li><li>Waldhausen</li><li>Waltrop</li></ul></li><li><strong>Hong Kong</strong><ul><li>Hong Kong</li></ul></li><li><strong>Hungary</strong><ul><li>Vácduka</li></ul></li><li><strong>India</strong><ul><li>Alwaye</li><li>Bangalore</li><li>Coimbatore</li><li>Goa</li><li>Langtore</li><li>Mumbai</li><li>Pune</li><li>Trivandrum</li></ul></li><li><strong>Italy</strong><ul><li>Catania</li><li>Sardinia</li></ul></li><li><strong>Kenya</strong><ul><li>Kisii</li><li>Kisumu</li><li>Nyakweri</li><li>Rodi</li><li>Kopany</li></ul></li><li><strong>Mexico</strong><ul><li>Leon</li></ul></li><li><strong>Netherlands</strong><ul><li>Flevoland</li><li>Groningen</li><li>Rotterdam</li><li>Schermer</li><li>Terwolde</li><li>Twente</li><li>Utrecht</li><li>Zeeland-Belgie</li></ul></li><li><strong>New Zealand</strong><ul><li>New Zealand</li></ul></li><li><strong>Norway</strong><ul><li>A-lag Brunstad</li><li>Bergen</li><li>Brunstad</li><li>Drammen</li><li>Eiker</li><li>Grenland</li><li>Hallingdal</li><li>Hamar</li><li>Harstad</li><li>Horten</li><li>Hønefoss</li><li>Molde</li><li>Måløy</li><li>Oslo/Follo</li><li>Sandefjord</li><li>Stavanger</li><li>Stord</li><li>Sørlandet</li><li>Tønsberg</li><li>Valdres</li><li>Østfold</li></ul></li><li><strong>Peru</strong><ul><li>Ilo</li></ul></li><li><strong>Poland</strong><ul><li>Malinka</li><li>Wroclaw</li></ul></li><li><strong>Romania</strong><ul><li>Adjud</li><li>Brasov</li><li>Bucharest</li><li>Caragiale</li><li>Crasna</li><li>Giurgiu</li></ul></li><li><strong>Russia</strong><ul><li>Central Russia</li><li>St. Petersburg</li></ul></li><li><strong>South Africa</strong><ul><li>Pretoria</li><li>Vanderbijlpark</li></ul></li><li><strong>Spain</strong><ul><li>Mallorca</li></ul></li><li><strong>Sri Lanka</strong><ul><li>Colombo</li></ul></li><li><strong>Switzerland</strong><ul><li>Schweiz</li></ul></li><li><strong>Turkey</strong><ul><li>Istanbul</li></ul></li><li><strong>Ukraine</strong><ul><li>Beljaevka</li><li>Ozornoe</li><li>Ternopol</li><li>Zakarpattia</li></ul></li><li><strong>United Arab Emirates</strong><ul><li>Dubai</li></ul></li><li><strong>USA</strong><ul><li>Connecticut</li><li>Delaware</li><li>Detroit</li><li>Missoula</li><li>Missouri</li><li>Salem</li><li>Seattle</li><li>Syracuse</li><li>Urbana</li></ul></li><li><strong>(no country)</strong><ul><li>A-lag MOBILT</li></ul></li></ul><h1 id="plugin-customization" tabindex="-1"><a class="header-anchor" href="#plugin-customization" aria-hidden="true">#</a> Plugin customization</h1><h2 id="hooks" tabindex="-1"><a class="header-anchor" href="#hooks" aria-hidden="true">#</a> Hooks</h2><p>This plugin provides a number of hooks to allow for a significant amount of customization of the plugin operations from elsewhere in the WordPress system (official documentation).</p><p>You can whitelist some custom URLs by using the bcc_unprotected_urls hook:</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string">&#39;bcc_unprotected_urls&#39;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">array</span><span class="token punctuation">(</span><span class="token string">&quot;https://example.com/custom-url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Whitelisted URLs will be accessible without being authenticated with BCC Signon</p><h2 id="actions" tabindex="-1"><a class="header-anchor" href="#actions" aria-hidden="true">#</a> Actions</h2>`,10),D=e("code",null,"add_action",-1),N={href:"https://github.com/oidc-wp/openid-connect-generic#actions",target:"_blank",rel:"noopener noreferrer"},U={href:"/_docs/bcc-signon/openid-connect#get-information-about-the-user",target:"_blank",rel:"noopener noreferrer"},q=e("h2",{id:"user-meta-data",tabindex:"-1"},[e("a",{class:"header-anchor",href:"#user-meta-data","aria-hidden":"true"},"#"),i(" User Meta Data")],-1),H={href:"https://github.com/oidc-wp/openid-connect-generic#user-meta-data",target:"_blank",rel:"noopener noreferrer"},O=a(`<h1 id="get-information-about-the-user" tabindex="-1"><a class="header-anchor" href="#get-information-about-the-user" aria-hidden="true">#</a> Get information about the user</h1><p>You can easily get information about the logged in user by using this method.</p><div class="language-javascript line-numbers-mode" data-ext="js"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">getUserAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    $user_id <span class="token operator">=</span> <span class="token function">get_current_user_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $claims <span class="token operator">=</span> <span class="token function">get_user_meta</span><span class="token punctuation">(</span>$user_id<span class="token punctuation">,</span> <span class="token string">&#39;openid-connect-generic-last-user-claim&#39;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    $attribute <span class="token operator">=</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">empty</span><span class="token punctuation">(</span>$claims<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        $attribute <span class="token operator">=</span> $claims<span class="token punctuation">[</span><span class="token string">&#39;ClaimName&#39;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> $attribute<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),M=e("code",null,"ClaimName",-1),j={href:"/_docs/bcc-signon/openid-connect#get-information-about-the-user",target:"_blank",rel:"noopener noreferrer"},z=a(`<h1 id="how-sso-data-is-handled" tabindex="-1"><a class="header-anchor" href="#how-sso-data-is-handled" aria-hidden="true">#</a> How SSO data is handled</h1><p><em>This article will describe how BCC distributes the BCC members personal data through it’s central login system called “BCC Login”</em></p><p>When a user logs in to a 3rd party website (from here-on called “website”) that is protected by BCC login, BCC login exchanges personal information about that user to the website, e.g. “display name”, “email”, “personId” etc.</p><p>Exactly what information is exchanged with the website is based on the request from the website, e.i. the website can specify during the login process what information it requires. Once the BCC login has exchanged this information with the website it loses control over the data which means that the website takes over the responsibility for what happens with this information in the future.</p><p>To get a bit more control over the above mentioned process, BCC has developed a plugin that can be installed in the website to manage this data.</p><p>If we take a specific case, for example with WordPress, then a WordPress website would install the BCC login plugin into their site and configure BCC login to work together with their site. When a user then logs in, the plugin then saves the user data to the WordPress database permanently, in order to create a session for the user. It is a known requirement to make this step configurable i.e. that the user can log in with BCC login but his data is never saved to the website, but as of today this has not yet been implemented.</p><h1 id="protect-uploads-files" tabindex="-1"><a class="header-anchor" href="#protect-uploads-files" aria-hidden="true">#</a> Protect Uploads files</h1><p>We have been notified that uploaded files on WordPress were not protected with BCC Signon, allowing a direct access using the file’s URL. This is true for all WordPress websites, also those protected by WordPress’s login system.</p><p>However, we are aware that this can be an issue for you local church website. Here will be described a way to prevent unprotected access to your uploads; this may be integrated to BCC’s Signon plugin in the future, but we want to get your feedback first to ensure it fits all of your configurations.</p><p><strong>This has been tested on a Linux server running Apache 2.4.18 and WordPress 5.2.3: please contact us if this isn’t working seamlessly for you.</strong></p><ol><li>Add the following file as <code>dl-file.php</code> to your WordPress root folder.</li></ol><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code>&lt;?php
/*
 * dl-file.php
 *
 * Protect uploaded files with login.
 *
 * @link http://wordpress.stackexchange.com/questions/37144/protect-wordpress-uploads-if-user-is-not-logged-in
 *
 * @author hakre &lt;http://hakre.wordpress.com/&gt;
* @license GPL-3.0+
* @registry SPDX
*/

require_once(&#39;wp-load.php&#39;);
require_once ABSPATH . WPINC . &#39;/formatting.php&#39;;
require_once ABSPATH . WPINC . &#39;/capabilities.php&#39;;
require_once ABSPATH . WPINC . &#39;/user.php&#39;;
require_once ABSPATH . WPINC . &#39;/meta.php&#39;;
require_once ABSPATH . WPINC . &#39;/post.php&#39;;
require_once ABSPATH . WPINC . &#39;/pluggable.php&#39;;
wp_cookie_constants();
ob_end_clean();
ob_end_flush();

is_user_logged_in() ||  auth_redirect();

list($basedir) = array_values(array_intersect_key(wp_upload_dir(), array(&#39;basedir&#39; =&gt; 1)))+array(NULL);

$file =  rtrim($basedir,&#39;/&#39;).&#39;/&#39;.str_replace(&#39;..&#39;, &#39;&#39;, isset($_GET[ &#39;file&#39; ])?$_GET[ &#39;file&#39; ]:&#39;&#39;);

if (!$basedir || !is_file($file)) {
status_header(404);
wp_redirect(home_url());
exit();
}

$mime = wp_check_filetype($file);
if( false === $mime[ &#39;type&#39; ] &amp;&amp; function_exists( &#39;mime_content_type&#39; ) )
$mime[ &#39;type&#39; ] = mime_content_type( $file );

if( $mime[ &#39;type&#39; ] )
$mimetype = $mime[ &#39;type&#39; ];
else
$mimetype = &#39;image/&#39; . substr( $file, strrpos( $file, &#39;.&#39; ) + 1 );

header( &#39;Content-Type: &#39; . $mimetype ); // always send this
if ( false === strpos( $_SERVER[&#39;SERVER_SOFTWARE&#39;], &#39;Microsoft-IIS&#39; ) )
header( &#39;Content-Length: &#39; . filesize( $file ) );

$last_modified = gmdate( &#39;D, d M Y H:i:s&#39;, filemtime( $file ) );
$etag = &#39;&quot;&#39; . md5( $last_modified ) . &#39;&quot;&#39;;
header( &quot;Last-Modified: $last_modified GMT&quot; );
header( &#39;ETag: &#39; . $etag );
header( &#39;Expires: &#39; . gmdate( &#39;D, d M Y H:i:s&#39;, time() + 1800 ) . &#39; GMT&#39; );

// Support for Conditional GET
$client_etag = isset( $_SERVER[&#39;HTTP_IF_NONE_MATCH&#39;] ) ? stripslashes( $_SERVER[&#39;HTTP_IF_NONE_MATCH&#39;] ) : false;

if( ! isset( $_SERVER[&#39;HTTP_IF_MODIFIED_SINCE&#39;] ) )
$_SERVER[&#39;HTTP_IF_MODIFIED_SINCE&#39;] = false;

$client_last_modified = trim( $_SERVER[&#39;HTTP_IF_MODIFIED_SINCE&#39;] );
// If string is empty, return 0. If not, attempt to parse into a timestamp
$client_modified_timestamp = $client_last_modified ? strtotime( $client_last_modified ) : 0;

// Make a timestamp for our most recent modification...
$modified_timestamp = strtotime($last_modified);

if ( ( $client_last_modified &amp;&amp; $client_etag )
? ( ( $client_modified_timestamp &gt;= $modified_timestamp) &amp;&amp; ( $client_etag == $etag ) )
: ( ( $client_modified_timestamp &gt;= $modified_timestamp) || ( $client_etag == $etag ) )
) {
status_header( 304 );
exit;
}

// If we made it this far, just serve the file
readfile( $file );
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>Append the following lines to your .htaccess.</li></ol><div class="language-html line-numbers-mode" data-ext="html"><pre class="language-html"><code>RewriteCond %{REQUEST_FILENAME} -s
RewriteRule ^wp-content/uploads/(.*)$ dl-file.php?file=$1 [QSA,L]
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="troubleshooting" tabindex="-1"><a class="header-anchor" href="#troubleshooting" aria-hidden="true">#</a> Troubleshooting</h1><p>If you get redirected to a page that says “Sorry, an error occurred”, please look at the url. It contains an ‘error description’ parameter. Sometimes, the error can’t be solved by you. The two most common cases are</p><ul><li><strong>Callback URL mismatch. example.com/callback is not in the list of allowed callback URLs</strong>: Contact <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a> and ask them to add the specified callback URL to your client.</li><li><strong>Grant type ‘authorization_code’ not allowed for the client</strong>: Contact <a href="mailto:it@bcc.no?subject=Support%Developer%BCC">support</a> and ask them to allow the specified grant type for your client.</li></ul><p>If you get the error: “Failed user creation” when logging in with OpenID Connect, you most likely have an existing WordPress user with the same email address as your BCC user, but with a username that is not your BCC person ID. In that case, either change the email address of the existing WordPress user or remove the WordPress user. After that you should no longer get the error.</p>`,18);function F(G,V){const n=l("ExternalLinkIcon");return o(),r("div",null,[c,e("ol",null,[e("li",null,[i("Download the latest version of the "),e("a",u,[i("BCC Signon Plugin"),t(n)]),i(".")]),h,e("li",null,[i("In the WordPress admin panel, go to "),p,i(" → "),g,i(" and configure the following "),e("ul",null,[m,b,f,e("li",null,[v,i(": Your "),e("a",w,[i("scopes"),t(n)]),i(". (E.g. email openid profile church)")]),_])]),y]),C,e("p",null,[i("This documentation assumes you have already installed WordPress. If you do not know how to install WordPress, please refer to the "),e("a",k,[i("official documentation"),t(n)]),i(" of WordPress.")]),S,P,I,e("ol",null,[e("li",null,[i("Download the latest version of "),e("a",B,[i("BCC Signon Plugin"),t(n)])]),T,x,$]),W,e("p",null,[i("Here you can request different scopes. More information is available "),e("a",E,[i("here"),t(n)]),i(".")]),L,e("p",null,[i("If you enable this, you can delete the old top bar script tag (See the "),e("a",A,[i("documentation of the old top bar"),t(n)]),i(")")]),R,e("p",null,[i("WordPress actions are generic events that other plugins can react to. You’ll probably only ever want to use "),D,i(" when hooking into this plugin ("),e("a",N,[i("official documentation"),t(n)]),i(").")]),e("p",null,[i("You can use the openid-connect-generic-update-user-using-current-claim action to add WordPress roles to the user, based on "),e("a",U,[i("signon claims"),t(n)]),i(".")]),q,e("p",null,[i("This plugin stores meta data about the user for both practical and debugging purposes ("),e("a",H,[i("official documentation"),t(n)]),i(").")]),O,e("p",null,[i("Where "),M,i(" is the name of the claim. All the available claims are documented "),e("a",j,[i("here"),t(n)]),i(".")]),z])}const K=s(d,[["render",F],["__file","wordpress.html.vue"]]);export{K as default};
